# 要件定義書
## GitLab Self-Managed（EE）を用いたLAN内Git/Wiki基盤（5VM分割）

---

## 1. 目的

* 自宅LAN内に **GitLab Self-Managed（Enterprise Edition: EE）** を構築し、以下を提供する。([GitLab ドキュメント][1])

  * Gitリポジトリ（clone / pull / push）
  * GitLab Wiki（社内Wiki用途）
  * GitHubを正本（メイン）としたリポジトリ同期（GitHub → GitLab）

---

## 2. 前提条件

### 2.1 物理基盤

* Proxmoxホスト上に仮想マシン（VM）として構築する。
* Proxmoxホストの想定リソース

  * RAM：32GB
  * ストレージ：SSD 500GB
  * CPU：Intel Core i7 第4世代

### 2.2 利用範囲

* アクセス範囲は **LAN内のみ** とする（インターネット公開は行わない）。

---

## 3. 採用ソフトウェア／OS／導入方式

### 3.1 GitLabエディション・導入方式

* GitLabは **GitLab EE** を採用する。([GitLab ドキュメント][1])
* インストール方式は **GitLab Linuxパッケージ（Omnibus）** を採用する。([GitLab ドキュメント][1])

### 3.2 OS

* 5VMすべて **Debian 12** を採用する。GitLab Linuxパッケージのサポート対象である。([GitLab ドキュメント][1])
* Debian 13は本構築では使用しない（Debian 13はGitLab EE 18.5.0以降が前提となるため）。([GitLab ドキュメント][1])

---

## 4. 全体構成（5VM）

本システムは、学習目的（実務寄りの構成理解）として、GitLabを以下の **5VM** に分割して構築する。

1. **lb-proxy**（入口／リバースプロキシ）

* LANクライアントからのHTTP/SSHアクセスの入口となる。
* HTTPはリバースプロキシでgitlab-appへ中継する。
* SSH（Git操作）は **TCP(L4)転送**でgitlab-appへ中継する（入口一本化）。

2. **gitlab-app**（アプリケーション）

* GitLabアプリケーション本体（Web UI/API、バックグラウンド処理等）を稼働させる。
* DB／Redis／Gitalyは外部（別VM）を利用する。

3. **gitlab-db**（DB）

* GitLab用データベースとして **PostgreSQL** を稼働させる。

4. **gitlab-redis**（Redis）

* GitLabが利用する **Redis** を稼働させる。

5. **gitlab-gitaly**（Gitaly）

* Gitリポジトリ実体を保持し、Gitalyとして提供する。
* Gitalyは認証・ストレージパス・ネットワークリスナー設定を行う。([GitLab ドキュメント][2])

---

## 5. URL・アクセス方式（DNS不要のIP運用）

### 5.1 外部URL（external_url）

* GitLabの `external_url` は **IPアドレスで設定**し、FQDN/DNS構築および各PCへのhosts配布を前提としない。

  * 例：`external_url "http://10.0.0.1"` のようにIPを使用可能である。([GitLab ドキュメント][3])

### 5.2 HTTPS

* 当面 **HTTPSは使用しない（HTTPで運用）**。([GitLab ドキュメント][3])

---

## 6. ネットワーク要件（LAN内）

### 6.1 IPアドレス

* 5VMはすべて **固定IP** とする（具体的な割当値は実装側で設定する）。

### 6.2 通信ポート（代表）

* LANクライアント → lb-proxy

  * HTTP：80/tcp（必須）
  * SSH：22/tcp（必須）
* lb-proxy → gitlab-app

  * HTTP転送（80/tcp もしくは内部指定ポート）
  * SSHのTCP(L4)転送（22/tcp もしくは内部指定ポート）
* gitlab-app → gitlab-db

  * PostgreSQL：5432/tcp
* gitlab-app → gitlab-redis

  * Redis：6379/tcp
* gitlab-app → gitlab-gitaly

  * Gitaly：設定したポート（LAN内限定）
* すべての内部向けポート（DB/Redis/Gitaly）は **LAN内・必要VM間のみに制限**する。

---

## 7. 機能要件

### 7.1 Git（必須）

* LAN内PCからGitLab上のプロジェクトリポジトリに対し、以下を実行できること：

  * clone / pull / push
* Git操作は、HTTPおよびSSHを利用可能とする（SSHはlb-proxyで入口一本化）。

### 7.2 Wiki（必須）

* GitLab WikiをLAN内で利用できること（閲覧・編集）。
* Wikiに画像を掲載する場合、**Git LFSは使用しない**。

  * 画像等は通常のファイルとしてWiki（Git）に格納する運用とする（LFS前提の構成・同期は行わない）。

### 7.3 GitHub同期（必須・全リポジトリ）

* **GitHubを正本（Source of Truth）** とし、GitLab側はGitHubの内容に一致させる。
* GitLabの **Repository Mirroring（Pull）** 機能で、GitHub → GitLabの同期を行う。([GitLab ドキュメント][4])
* 認証方式は **SSH public key** を用いる。

  * GitLabでミラー設定時にSSH public keyを選択すると、GitLabが公開鍵を生成する。([GitLab ドキュメント][4])
  * 生成された公開鍵はGitHub側の **専用アカウント（機械ユーザー）** に **SSH key** として登録し、当該アカウントに同期対象の全リポジトリへの参照権限を付与することで、GitLabがGitHubへSSHでアクセスできる状態とする（アカウント単位で管理）。
* 運用ルール：

  * 正本はGitHubのため、原則として変更（push/merge）はGitHub側で行う。
  * GitLab側はLAN内配布（clone）・閲覧・Wiki用途として利用し、リポジトリ内容の乖離を発生させない。

### 7.4 CI/CD（Runner）

* 現時点では **GitLab Runnerは導入しない**。

### 7.5 メール（SMTP）

* 現時点では **メール送信（SMTP）は構築しない**（LAN内運用で必須ではない）。

---

## 8. ストレージ要件

### 8.1 リポジトリ配置

* Gitリポジトリ実体は **gitlab-gitalyのローカルディスク**に配置する。
* 必要容量は「Gitリポジトリ合計容量以上」を確保する（GitLabのストレージ要件に準拠）。([GitLab ドキュメント][5])

---

## 9. バックアップ／リストア要件（短時間停止を許容）

### 9.1 バックアップ方針

* GitLabのバックアップは **GitLab公式のバックアップ機能**を用いて取得する。([GitLab ドキュメント][6])
* バックアップ取得時の整合性担保のため、**短時間のメンテナンス停止を許容**する。

### 9.2 バックアップ対象（必須）

* GitLabバックアップに含まれるデータ（例：DB、リポジトリ、Wiki等）を取得する。([docs.gitlab.co.jp][7])
* 分割構成におけるリポジトリバックアップは、GitLabバックアップ処理が `gitaly-backup` を用いてGitalyから取得・復元する前提とする。([GitLab ドキュメント][6])
* **設定・秘密情報はバックアップに含まれない**ため、別途バックアップする。

  * GitLabは `/etc/gitlab`（設定ファイル）、TLS鍵/証明書、システムファイルをバックアップしない。([docs.gitlab.co.jp][7])
  * リストア時には **GitLab secrets の復元が必須**（secretsが無いと暗号化データ等に支障が出る）。([GitLab ドキュメント][8])
* Redis（Sidekiqジョブ）はバックアップ対象外である前提とする。([docs.gitlab.co.jp][7])

### 9.3 バックアップ保管先

* 取得したバックアップアーカイブおよび設定・secrets等のバックアップは、**VM外（Proxmoxホスト側の保管領域）** に退避する。

---

## 10. セキュリティ要件（LAN内前提）

* 外部公開は行わず、アクセスはLAN内に限定する。
* DB/Redis/GitalyはLAN内かつ必要VM間通信に限定し、不要な到達性を排除する。
* Gitalyは認証を構成する（トークン等）こと。([GitLab ドキュメント][2])

---

[1]: https://docs.gitlab.com/install/package/?utm_source=chatgpt.com "Install GitLab using the Linux package"
[2]: https://docs.gitlab.com/administration/gitaly/configure_gitaly/?utm_source=chatgpt.com "Configure Gitaly"
[3]: https://docs.gitlab.com/omnibus/settings/configuration/?utm_source=chatgpt.com "Configuration options for Linux package installations"
[4]: https://docs.gitlab.com/user/project/repository/mirror/?utm_source=chatgpt.com "Repository mirroring"
[5]: https://docs.gitlab.com/install/requirements/?utm_source=chatgpt.com "GitLab installation requirements"
[6]: https://docs.gitlab.com/administration/backup_restore/backup_gitlab/?utm_source=chatgpt.com "Back up GitLab"
[7]: https://docs.gitlab.co.jp/ee/raketasks/backup_gitlab.html?utm_source=chatgpt.com "Back up GitLab"
[8]: https://docs.gitlab.com/administration/backup_restore/restore_gitlab/?utm_source=chatgpt.com "Restore GitLab"