# 設計書
## GitLab Self-Managed（EE）を用いたLAN内Git/Wiki基盤（6VM分割）

---

## 1. 目的・スコープ

* 自宅LAN内にGitLab EEを構築し、GitリポジトリとGitLab Wikiを提供する。
* GitHubを正本とし、LAN内のself-hosted runner上で動作するGitHub ActionsによりGitHubからGitLabへミラーpushで同期する。
* 外部公開は行わない（LAN内のみ）。
* 学習目的として6VM分割構成を採用し、役割分離と運用手順の理解を目的とする。

---

## 2. 前提・制約

* 仮想化基盤: Proxmox上のVM。
* OS: Debian 12（全VM）。
* GitLab導入方式: GitLab Linuxパッケージ（Omnibus）。
* HTTPSは使用しない（HTTP運用）。
* GitLab Runner（GitLab CI用） / SMTPは導入しない。
* Git LFSは使用しない（Wiki画像も通常ファイルとして格納）。

---

## 3. 全体構成

### 3.1 コンポーネント構成

1. lb-proxy（入口／リバースプロキシ）
2. gitlab-app（アプリケーション）
3. gitlab-db（PostgreSQL）
4. gitlab-redis（Redis）
5. gitlab-gitaly（Gitaly）
6. gha-runner（GitHub Actions self-hosted runner）

### 3.2 論理構成（文章）

* LANクライアントはlb-proxyへHTTP/SSH接続する。
* lb-proxyはHTTPをgitlab-appへリバースプロキシ、SSHはL4転送でgitlab-appへ中継する。
* gitlab-appはDB/Redis/Gitalyへそれぞれ専用ポートで接続する。
* LAN内のself-hosted runner上で動作するGitHub ActionsがGitHubからGitLabへSSHでpushし、GitLab側は受信のみとする。

---

## 4. VM設計

### 4.1 VM一覧と推奨スペック（個人利用想定）

* lb-proxy
  * 役割: HTTP/SSH入口
  * ソフト: Nginx
  * vCPU: 1
  * RAM: 1GB
  * Disk: 10GB
* gitlab-app
  * 役割: GitLab Web/API/Sidekiq
  * ソフト: GitLab EE（Omnibus）
  * vCPU: 4
  * RAM: 8GB
  * Disk: 50GB（ログ/一時領域/バックアップ作業領域）
* gitlab-db
  * 役割: PostgreSQL
  * vCPU: 2
  * RAM: 4GB
  * Disk: 50GB（DBサイズに応じて増設）
* gitlab-redis
  * 役割: Redis
  * vCPU: 1
  * RAM: 2GB
  * Disk: 10GB
* gitlab-gitaly
  * 役割: Gitaly（リポジトリ実体）
  * vCPU: 2
  * RAM: 8GB
  * Disk: 200GB（リポジトリ総量に応じて調整）
* gha-runner
  * 役割: GitHub Actions self-hosted runner（GitHub→GitLab mirror push を実行）
  * OS: Debian 12
  * vCPU: 1
  * RAM: 2GB
  * Disk: 30GB

合計目安: 11 vCPU / 25GB RAM / 350GB Disk

### 4.2 ストレージ設計

* リポジトリ実体はgitlab-gitalyのローカルディスクに配置する。
* 目安容量: 合計リポジトリサイズの1.5倍 + 20%ヘッドルーム。
* バックアップアーカイブはVM外（Proxmoxホスト側）へ退避する。
* DB領域は初期50GBとし、必要時に拡張する。

### 4.3 OS・基盤共通設定

* ホスト名を固定し、各VMで一意に設定する。
* 時刻同期: systemd-timesyncd または chronyを有効化する。
* パッケージ更新: セキュリティ更新のみを定期適用する方針とする。
* ログローテーション: OS標準のlogrotateを利用する。

---

## 5. ネットワーク設計

### 5.1 IP設計

* 各VMは固定IPを割り当てる（具体値は後決定）。

### 5.2 ポート設計

* LANクライアント → lb-proxy
  * 80/tcp（HTTP）
  * 22/tcp（SSH）
* lb-proxy → gitlab-app
  * 80/tcp（HTTP転送）
  * 22/tcp（SSH L4転送）
* gitlab-app → gitlab-db
  * 5432/tcp
* gitlab-app → gitlab-redis
  * 6379/tcp
* gitlab-app → gitlab-gitaly
  * 8075/tcp（Gitalyデフォルト）
* gha-runner → GitHub（インターネット）
  * 443/tcp outbound
* gha-runner → lb-proxy
  * 22/tcp（mirror push）

### 5.3 DNS／URL

* GitLab `external_url` はIPアドレスを用いる。
* 例: `external_url "http://<lb-proxyのIP>"`

---

## 6. lb-proxy（Nginx）設計

### 6.1 役割

* HTTPはリバースプロキシでgitlab-appへ中継する。
* SSHはL4転送でgitlab-appへ中継する（Nginx stream）。

### 6.2 Nginxインストール

* `apt update && apt install -y nginx libnginx-mod-stream`
* streamが利用可能であること（モジュールが読み込まれていること）を前提とする。

### 6.3 設定方針（要点）

* HTTP
  * `proxy_pass` でgitlab-appへ転送する。
  * `X-Forwarded-For` / `X-Forwarded-Proto` を付与する。
* SSH
  * `stream` ブロックで22/tcpをgitlab-appへ転送する。

### 6.4 設定例（Nginx）

streamはトップレベル（http{}と同階層）に置く必要があるため、HTTP設定とSSH設定は配置場所を分離する。

例:

`/etc/nginx/nginx.conf`（トップレベルにstream includeを追加）

```nginx
stream {
  include /etc/nginx/stream.d/*.conf;
}
```

`/etc/nginx/stream.d/gitlab-ssh.conf`（SSH L4転送の例）

```nginx
upstream gitlab_ssh {
  server <gitlab-app-ip>:22;
}

server {
  listen 22;
  proxy_pass gitlab_ssh;
}
```

`/etc/nginx/conf.d/gitlab-http.conf`（HTTPリバースプロキシの例）

```nginx
server {
  listen 80;
  server_name _;

  location / {
    proxy_pass http://<gitlab-app-ip>;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
```

---

## 7. GitLabアプリケーション設計

### 7.1 GitLabパッケージインストール

* 公式リポジトリを利用してGitLab EEをインストールする。
* 例:

```bash
apt update
apt install -y curl openssh-server ca-certificates
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | bash
EXTERNAL_URL="http://<lb-proxy-ip>" apt install -y gitlab-ee
```

### 7.2 external_url

* `external_url "http://<lb-proxyのIP>"`

### 7.3 外部DB/Redis/Gitaly接続（gitlab.rb 設定例）

`/etc/gitlab/gitlab.rb` の主要項目を以下の通り設定する。

* ローカルGitalyは無効化する（`gitaly['enable'] = false`）。
* `gitlab_rails['gitaly_token']` はGitaly側と同一値にする。
* `gitlab_rails['repositories_storages']` でGitalyアドレスを指定する。

```ruby
external_url "http://<lb-proxy-ip>"

# PostgreSQL
postgresql['enable'] = false
# host, port, username, password は実環境値を設定
# gitlab_rails['db_host'] = '<gitlab-db-ip>'
# gitlab_rails['db_port'] = 5432
# gitlab_rails['db_username'] = 'gitlab'
# gitlab_rails['db_password'] = '<db_password>'

# Redis
redis['enable'] = false
# gitlab_rails['redis_host'] = '<gitlab-redis-ip>'
# gitlab_rails['redis_port'] = 6379

# Gitaly (remote)
gitaly['enable'] = false
# gitlab_rails['gitaly_token'] = '<gitaly_token>'
# gitlab_rails['repositories_storages'] = {
#   'default' => { 'gitaly_address' => 'tcp://<gitlab-gitaly-ip>:8075' }
# }
```

設定後は `gitlab-ctl reconfigure` を実行する。

### 7.4 リポジトリ同期（GitHub → GitLab）

* GitHubを正本とし、LAN内のself-hosted runner上で動作するGitHub ActionsによりGitHubからGitLabへミラーpushする。
* 同期タイミング: push時に即時実行 + 毎時の定期実行。手動実行（workflow_dispatch）も用意する。
* 認証方式: SSH public key。
  * GitLab側に専用アカウント（機械ユーザー）を作成する。
  * 機械ユーザーにSSH公開鍵を登録し、同期対象の全プロジェクトへ書き込み権限を付与する。
  * GitHub側にSSH秘密鍵をSecretsとして登録する。
* GitLab側は原則読み取り用途とし、人的操作によるpushは禁止運用とする。
* self-hosted runnerはlb-proxyへ22/tcpで到達可能であることを前提とする。

### 7.5 GitHub Actions 設計（同期用）

* GitHub Actionsは対象リポジトリに設定する（テンプレートを各リポジトリへ配布）。
* self-hosted runnerはLAN内に配置し、lb-proxyの22/tcpへ到達できることを確認する。
* self-hosted runnerはLAN内のgha-runner上で動作する。
* gha-runnerはGitHubへ443/tcp（アウトバウンド）で到達可能であり、lb-proxyへ22/tcpで到達可能であることを前提とする。
* Secrets: `GITLAB_SSH_PRIVATE_KEY`（GitLab機械ユーザーのSSH秘密鍵）, `GITLAB_SSH_HOST`（`<lb-proxy-ip>`）, `GITLAB_SSH_PORT`（22）, `GITLAB_REPO_URL`（`git@<lb-proxy-ip>:<namespace>/<repo>.git`）。
* Known hosts: `ssh-keyscan -p 22 <lb-proxy-ip>` でホスト鍵を追加する。

#### 7.5.1 ワークフロー例（各リポジトリに配置）

`.github/workflows/gitlab-mirror.yml` の例:

```yaml
name: Mirror to GitLab

on:
  push:
  schedule:
    - cron: '0 * * * *' # 毎時
  workflow_dispatch:

jobs:
  mirror:
    runs-on: self-hosted
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${GITLAB_SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${GITLAB_SSH_PORT} ${GITLAB_SSH_HOST} >> ~/.ssh/known_hosts
        env:
          GITLAB_SSH_PRIVATE_KEY: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}
          GITLAB_SSH_HOST: ${{ secrets.GITLAB_SSH_HOST }}
          GITLAB_SSH_PORT: ${{ secrets.GITLAB_SSH_PORT }}

      - name: Push mirror to GitLab
        run: |
          git remote add gitlab "${GITLAB_REPO_URL}"
          git push --mirror gitlab
        env:
          GITLAB_REPO_URL: ${{ secrets.GITLAB_REPO_URL }}
```

### 7.6 Wiki

* GitLab Wikiを利用する。
* 画像等は通常ファイルとしてWiki Gitに格納する（Git LFSは使用しない）。

### 7.7 ユーザー・権限設計（最小）

* 管理者アカウントは1つとし、初期パスワードは後決定。
* プロジェクト作成権限は管理者のみ（個人利用前提）。

---

## 8. DB設計（PostgreSQL）

### 8.1 役割

* GitLabのメタデータを保持する。

### 8.2 インストール

```bash
apt update
apt install -y postgresql
```

### 8.3 設定方針（要点）

* 接続許可はgitlab-appからの5432/tcpのみとする。
* `pg_hba.conf` でgitlab-appのみを許可する。

### 8.4 初期設定（例）

```bash
# ユーザーとDB作成（例）
sudo -u postgres psql -c "CREATE USER gitlab WITH PASSWORD '<db_password>';"
sudo -u postgres psql -c "CREATE DATABASE gitlabhq_production OWNER gitlab;"
```

---

## 9. Redis設計

### 9.1 役割

* GitLabのキャッシュ/ジョブ管理用途。

### 9.2 インストール

```bash
apt update
apt install -y redis-server
```

### 9.3 設定方針（要点）

* 接続許可はgitlab-appからの6379/tcpのみとする。
* Redisデータはバックアップ対象外とする。

---

## 10. Gitaly設計

### 10.1 役割

* Gitリポジトリ実体の保持。

### 10.2 インストール

* GitLab EEパッケージに含まれるGitalyを利用する。

### 10.3 設定方針

* ポート番号: 8075（デフォルト）。
* 認証トークン: 長い文字列を別管理し、gitlab-appとgitlab-gitalyに同一値を設定する。
* Gitaly専用ノードではRails系サービスを起動しない（puma/sidekiq/workhorse/nginx等をdisable）。
* `gitlab_rails['auto_migrate'] = false` を設定し、reconfigure時のDB接続を防ぐ。
* `gitlab_rails['internal_api_url']` をlb-proxyのHTTP URLに設定する（未設定だとpush失敗の可能性）。
* Gitalyの設定は `gitaly['configuration']` に集約する。
* `/etc/gitlab/gitlab-secrets.json` をgitlab-appからgitlab-gitalyへコピーし、secrets整合性を維持する（不整合時に401でpush失敗が起き得る）。

### 10.4 設定例（gitlab.rb）

```ruby
# gitlab-gitaly 側
external_url "http://<gitlab-gitaly-ip>"

# 内蔵サービス無効化（Gitaly単体運用）
postgresql['enable'] = false
redis['enable'] = false
nginx['enable'] = false
puma['enable'] = false
sidekiq['enable'] = false
gitlab_workhorse['enable'] = false
gitlab_exporter['enable'] = false
prometheus_monitoring['enable'] = false
alertmanager['enable'] = false
node_exporter['enable'] = false
postgres_exporter['enable'] = false
redis_exporter['enable'] = false
sidekiq_exporter['enable'] = false

# DB接続抑止と内部API
gitlab_rails['auto_migrate'] = false
gitlab_rails['internal_api_url'] = 'http://<lb-proxy-ip>'

# Gitaly設定（configurationに集約）
gitaly['enable'] = true
gitaly['configuration'] = {
  'listen_addr' => '0.0.0.0:8075',
  'auth' => { 'token' => '<gitaly_token>' },
  'storage' => [
    { 'name' => 'default', 'path' => '/var/opt/gitlab/git-data/repositories' }
  ]
}
```

### 10.5 secrets整合性（重要）

* `/etc/gitlab/gitlab-secrets.json` はgitlab-appとgitlab-gitalyで一致させる。
* 推奨手順: gitlab-appからgitlab-gitalyへファイルを安全にコピーする。

例:

```bash
# gitlab-appで実行
scp /etc/gitlab/gitlab-secrets.json <user>@<gitlab-gitaly-ip>:/etc/gitlab/gitlab-secrets.json
```

コピー後は所有者と権限を確認する。

```bash
# gitlab-gitalyで実行
chown root:root /etc/gitlab/gitlab-secrets.json
chmod 600 /etc/gitlab/gitlab-secrets.json
```

---

## 11. セキュリティ設計（LAN内前提）

* インターネット公開は行わない。
* DB/Redis/Gitalyは必要VM間のみに通信制限する。
* Nginxで受けるのはHTTP/SSHのみとする。
* 管理者パスワードは別管理し、共有手段は後決定。
* Gitalyトークンは別管理し、漏洩しないよう保護する。

---

## 12. バックアップ設計

### 12.1 バックアップ方針

* GitLab公式バックアップ機能を使用する。
* 整合性のため短時間停止を許容する。

### 12.2 対象と対象外

* 対象: DB、リポジトリ、Wiki 等。
* 対象外: Redis（Sidekiqジョブ）、`/etc/gitlab`、TLS鍵/証明書、GitLab secrets。
* `gitlab-secrets.json` を含む設定/秘密情報は別途バックアップする。

### 12.3 スケジュール・世代

* スケジュール: 毎日1回（例: 02:00）。
* 世代: 2世代保持。
* 保管容量: 小容量運用のため、古い世代は即時削除する。

### 12.4 バックアップ実行例

```bash
gitlab-ctl stop puma
gitlab-ctl stop sidekiq
gitlab-backup create
gitlab-ctl start
```

### 12.5 保管先

* バックアップアーカイブと設定・secretsはVM外（Proxmoxホスト側）へ退避する。

---

## 13. 運用設計

### 13.1 同期運用

* 正本はGitHubであることを周知する。
* LAN内のself-hosted runner上で動作するGitHub Actionsが「push時に即時実行」および「毎時の定期実行」でGitLabへミラーpushする。
* self-hosted runnerはlb-proxyへ22/tcpで到達可能であることを前提とする。
* GitLab側でのpush/mergeは原則禁止とし、読み取り用途を主体とする。

### 13.2 監視・ログ

* OSとGitLabの標準ログを確認できること。
* エラーログ（Nginx、GitLab）を定期的に確認する。

### 13.3 変更管理

* GitLab設定変更は`/etc/gitlab/gitlab.rb`の変更履歴を残す。

---

## 14. 未確定事項（確認が必要）

* 各VMのIPアドレス。
* GitLab管理者アカウントの初期パスワード運用。
